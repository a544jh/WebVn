<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>AP Canvas</title>
</head>

<body>
    <canvas id="canvas" width="2000" height="400"></canvas>
    <div id="debug"></div>
    <canvas id="work_canvas" width="2000" height="400"></canvas>
</body>
<script>
    let canvas = document.getElementById('canvas')
    let ctx = canvas.getContext('2d')

    let workCanvas = document.getElementById('work_canvas')
    let workCtx = workCanvas.getContext('2d')

    let step = 0

    let fill = 0
    let ripplePoint = 0


    function animate() {
        ctx.clearRect(0, 0, 2000, 400)
        ctx.save()

        workCtx.clearRect(0, 0, 2000, 400)
        workCtx.save()

        //let scaleFactor = 8 * Math.sin(step * .01) + 8
        let scaleFactor = 4
        ctx.scale(scaleFactor, scaleFactor)
        workCtx.scale(scaleFactor, scaleFactor)

        let maxBarLength = 360
        let barLength = maxBarLength

        //border
        ctx.fillStyle = 'black'
        ctx.fillRect(0, 0, 400, 20)
        ctx.strokeStyle = 'white'
        ctx.lineWidth = 2
        ctx.strokeRect(30 - 1, 5 - 1, maxBarLength + 2, 10 + 2)

        let gradient = ctx.createLinearGradient(30, 0, 30 + barLength, 0)
        gradient.addColorStop(0, '#00ff00')

        //add ripple(s)
        if (ripplePoint - .05 > 0) gradient.addColorStop(ripplePoint - .05, '#00ff00')
        gradient.addColorStop(ripplePoint, 'rgba(255,255,255,1)')

        let rippleEnd = ripplePoint + .01
        let glowStart = fill - .01

        if (rippleEnd < glowStart) {
            gradient.addColorStop(rippleEnd, 'rgba(0,255,0,1)')
            gradient.addColorStop(glowStart, '#00ff00')
        } else if (glowStart > 0) {
            let [x, y] = intersect(ripplePoint, rippleEnd, glowStart, fill)
            let c = lerpRGBA('rgba(0,255,0,1)', 'rgba(255,255,255,1)', y)
            gradient.addColorStop(x, c)
        }

        gradient.addColorStop(fill, '#ffffff')

        if (fill + .01 < 1) gradient.addColorStop(fill + .01, '#ff0000')

        gradient.addColorStop(1, '#ff0000')

        ctx.fillStyle = gradient
        ctx.save()
        //ctx.shadowBlur = 4
        //ctx.shadowColor = '#00ff00'
        //draw progress bar
        //ctx.filter = 'blur(30px)'
        ctx.fillRect(30, 5, barLength, 10)
        ctx.restore()

        let glowGradient = workCtx.createLinearGradient(0, 5, 0, 0) // top glow
        glowGradient.addColorStop(0, 'rgba(0,0,0,1)')
        glowGradient.addColorStop(1, 'rgba(255,255,255,0)')
        workCtx.fillStyle = glowGradient
        workCtx.fillRect(30, 0, barLength, 5 + 1)

        workCtx.fillStyle = gradient
        workCtx.globalCompositeOperation = 'source-in'
        workCtx.fillRect(30, 0, barLength, 5 + 1)

        ctx.save()
        ctx.resetTransform()
        ctx.drawImage(workCanvas, 0, 0)
        ctx.restore()

        ctx.fillStyle = 'white'
        ctx.font = 'bold 12px monospace'
        ctx.textBaseline = 'top'
        ctx.fillText('AP', 2, 5)

        ctx.restore()
        workCtx.restore()

        document.getElementById('debug').innerText = `fill ${fill} 
        rippleEnd ${rippleEnd}
        ripple ${ripplePoint}`


        if (fill < 1) fill += .0001
        if (fill >= 1) fill = 1

        ripplePoint += .001
        if (ripplePoint >= fill) ripplePoint = 0

        step += 1

        window.requestAnimationFrame(animate)
    }

    window.requestAnimationFrame(animate)


    // given two slopes y=0,1, find their intersection y value
    function intersect(top1, bottom1, bottom2, top2) {
        let slope1 = -1 / (bottom1 - top1)
        let slope2 = 1 / (top2 - bottom2)
        // slope1 * top1 + i1 = 1
        // i1 = 1 - slope1 * top1
        let i1 = 1 - slope1 * top1
        let i2 = 1 - slope2 * top2
        // x*slope1 + i1 = x*slope2 + i2
        let x = (i2 - i1) / (slope1 - slope2)
        let y = x * slope1 + i1
        return [x, y]
    }

    function lerp(start, end, t) {
        return start * (1 - t) + end * t
    }

    function arrLerp(arr1, arr2, t) {
        res = []
        for (let i = 0; i < arr1.length; i++) {
            res.push(lerp(arr1[i], arr2[i], t))
        }
        return res
    }

    function parseRGB(input) {
        return input.split("(")[1].split(")")[0].split(",").map(x => +x)
    }

    function lerpRGBA(c1, c2, t) {
        let a1 = parseRGB(c1)
        let a2 = parseRGB(c2)
        let res = arrLerp(a1, a2, t).map(x => x.toFixed(0))
        return `rgba(${res.join(',')})`
    }
</script>

</html>